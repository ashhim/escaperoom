<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Escape Room TV Display</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      background: linear-gradient(#6ec6ff, #b3e5fc);
      overflow-x: hidden;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      margin: 0;
      padding: 0;
    }
    /* Ready screen */
    .ready-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #111;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12vw;
      font-weight: bold;
      z-index: 1000;
    }
    /* Game Over screen */
    .game-over-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgb(179, 0, 0);
      color: white;
      font-size: 15vw;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    /* Timer */
    .timer-display {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 33vw;
      font-weight: 900;
      color: transparent;
      -webkit-text-stroke: 5px rgba(44, 44, 44, 0.2);
      text-shadow: 4px 4px 15px rgba(0, 255, 85, 0.2);
      pointer-events: none;
      z-index: 999;
    }
    .progress-section {
      position: relative;
      margin-top: 300px;
    }
    .progress-track {
      position: relative;
      height: 250px;
    }
    .stage {
      background: #ffb300;
      color: #fff;
      font-size: 1.5rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      position: absolute;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      animation: popStage 0.5s ease-in-out;
      z-index: 2;
    }
    .stage.active {
      background: #ffe600;
      color: #000;
      transform: scale(1.4);
      transition: transform 0.3s ease;
    }
    @keyframes popStage {
      0% { transform: scale(0); }
      100% { transform: scale(1); }
    }
    #stage1 { top: 0; left: 0%; }
    #stage2 { top: 150px; left: 20%; }
    #stage3 { top: 0; left: 40%; }
    #stage4 { top: 150px; left: 60%; }
    #stage5 { top: 0; left: 80%; }
    svg.curve-path {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 250px;
      z-index: 1;
    }
    path {
      stroke: #fff;
      stroke-width: 4;
      stroke-dasharray: 10 8;
      fill: none;
      filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.4));
    }
    .avatar {
      position: absolute;
      font-size: 3rem;
      transform: translate(-50%, -50%);
      z-index: 3;
    }
    .final-message {
      font-size: 2rem;
      color: #79ad8f;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      margin-top: 20px;
      animation: pulse 1s infinite alternate;
    }
    @keyframes pulse {
      0% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    /* Hide game until started */
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <!-- Ready screen -->
  <div id="readyScreen" class="ready-screen">Are You Ready</div>

  <!-- Game Over screen -->
  <div id="gameOverScreen" class="game-over-screen hidden">GAME OVER</div>

  <!-- Game container -->
  <div id="gameContainer" class="container hidden">
    <div class="timer-display" id="timerDisplay">10:00</div>
    <div class="progress-section">
      <div class="progress-track">
        <svg class="curve-path">
          <path id="path1" d="M30,30 C150,150 150,150 220,180" />
          <path id="path2" d="M220,180 C300,30 300,30 400,30" />
          <path id="path3" d="M400,30 C500,150 500,150 600,180" />
          <path id="path4" d="M650,180 C700,30 700,30 800,30" />
        </svg>
        <div class="stage" id="stage1">1</div>
        <div class="stage" id="stage2">2</div>
        <div class="stage" id="stage3">3</div>
        <div class="stage" id="stage4">4</div>
        <div class="stage" id="stage5">5</div>
        <div class="avatar" id="avatar">üèÉüèª‚Äç‚û°Ô∏è</div>
      </div>
    </div>
    <div class="final-message" id="finalMessage"></div>
  </div>

  <!-- Background audio -->
  <audio id="startAudio" src="mp3\start.mp3" preload="auto"></audio>
  <audio id="readyAudio" src="mp3\ready.mp3" preload="auto" loop></audio>

  <!-- Game Over sounds -->
  <audio id="over1Audio" src="mp3\over1.mp3" preload="auto"></audio>
  <audio id="over2Audio" src="mp3\over2.mp3" preload="auto"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDlI0S22vdMexvdUQjEFLr0I5bvFoiPwjo",
      authDomain: "escaperoom-53adb.firebaseapp.com",
      projectId: "escaperoom-53adb",
      storageBucket: "escaperoom-53adb.appspot.com",
      messagingSenderId: "379297108835",
      appId: "1:379297108835:web:48a5c5ca71b091cc567956",
      databaseURL: "https://escaperoom-53adb-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const avatar = document.getElementById("avatar");
    const stages = document.querySelectorAll(".stage");
    const finalMessage = document.getElementById("finalMessage");
    const timerDisplay = document.getElementById("timerDisplay");
    const readyScreen = document.getElementById("readyScreen");
    const gameContainer = document.getElementById("gameContainer");
    const gameOverScreen = document.getElementById("gameOverScreen");
    const startAudio = document.getElementById("startAudio");
    const readyAudio = document.getElementById("readyAudio");
    const over1Audio = document.getElementById("over1Audio");
    const over2Audio = document.getElementById("over2Audio");

    let countdownDuration = 10 * 60;
    let countdownInterval = null;
    let timerStarted = false;
    let currentLevel = 1;

    function moveAlongPath(pathId, onComplete) {
      const path = document.getElementById(pathId);
      const length = path.getTotalLength();
      let progress = 0;
      function step() {
        progress += 2;
        if (progress > length) {
          if (onComplete) setTimeout(onComplete, 200);
          return;
        }
        const point = path.getPointAtLength(progress);
        const jump = Math.sin(progress / 15) * 8;
        avatar.style.left = `${point.x}px`;
        avatar.style.top = `${point.y - jump}px`;
        requestAnimationFrame(step);
      }
      step();
    }

    function placeAtStage(stageId) {
      const stage = document.getElementById(stageId);
      const rect = stage.getBoundingClientRect();
      const parentRect = stage.parentElement.getBoundingClientRect();
      avatar.style.left = `${rect.left - parentRect.left + rect.width / 2}px`;
      avatar.style.top = `${rect.top - parentRect.top + rect.height / 2}px`;
    }

    function goToLevel(level) {
      if (level <= 1) return;
      moveAlongPath(`path${level - 1}`, () => {
        currentLevel = level;
      });
    }

    function showGameOver() {
      gameContainer.classList.add("hidden");
      gameOverScreen.classList.remove("hidden");
      gameOverScreen.textContent = "GAME OVER";

      // Stop any previous playback
      over1Audio.pause();
      over2Audio.pause();
      over1Audio.currentTime = 0;
      over2Audio.currentTime = 0;

      // Play over1 first
      over1Audio.play().then(() => {
        over1Audio.onended = () => {
          gameOverScreen.textContent = "Eliminated"; // Change text
          over2Audio.play().catch(err => console.warn("Over2 autoplay blocked:", err));
        };
      }).catch(err => console.warn("Over1 autoplay blocked:", err));
    }

    function hideGameOver() {
      gameOverScreen.classList.add("hidden");
    }

    function startReadyMusic() {
      readyAudio.currentTime = 0;
      readyAudio.play().catch(err => console.warn("Ready audio autoplay blocked:", err));
    }

    function stopReadyMusic() {
      readyAudio.pause();
      readyAudio.currentTime = 0;
    }

    onValue(ref(db, "timer/start"), (snapshot) => {
      const startFlag = snapshot.val();
      if (startFlag && !timerStarted) {
        hideGameOver();
        readyScreen.classList.add("hidden");
        gameContainer.classList.remove("hidden");

        stopReadyMusic();
        startAudio.currentTime = 0;
        startAudio.play().catch(err => console.warn("Audio autoplay blocked:", err));

        timerStarted = true;
        startCountdown();
        document.body.classList.add("tasks-enabled");
      }
      if (!startFlag) {
        stopCountdown();
        document.body.classList.remove("tasks-enabled");
        gameContainer.classList.add("hidden");
        gameOverScreen.classList.add("hidden");
        readyScreen.classList.remove("hidden");
        currentLevel = 1;
        placeAtStage("stage1");
        countdownDuration = 10 * 60;
        updateTimerDisplay(countdownDuration);
        finalMessage.textContent = "";
        startReadyMusic();
      }
    });

    function startCountdown() {
      clearInterval(countdownInterval);
      countdownInterval = setInterval(() => {
        if (countdownDuration <= 0) {
          clearInterval(countdownInterval);
          timerDisplay.textContent = "00:00";
          set(ref(db, "finalMessage"), "Time‚Äôs up! Game Over!");
          showGameOver();
          return;
        }
        countdownDuration--;
        updateTimerDisplay(countdownDuration);
        set(ref(db, "timer/remaining"), countdownDuration);
      }, 1000);
    }

    function stopCountdown() {
      clearInterval(countdownInterval);
      timerStarted = false;
    }

    function updateTimerDisplay(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      timerDisplay.textContent = `${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
    }

    onValue(ref(db, "timer/remaining"), (snapshot) => {
      const remaining = snapshot.val();
      if (remaining !== null) {
        countdownDuration = remaining;
        updateTimerDisplay(remaining);
      }
    });

    onValue(ref(db, "level"), (snapshot) => {
      const level = snapshot.val();
      if (!level) return;
      stages.forEach((stage, index) => {
        stage.classList.toggle("active", index < level);
      });
      if (level > currentLevel) {
        goToLevel(level);
      } else if (level < currentLevel) {
        currentLevel = level;
        if (level === 1) {
          placeAtStage("stage1");
        }
      }
    });

    onValue(ref(db, "finalMessage"), (snapshot) => {
      const msg = snapshot.val();
      finalMessage.textContent = msg || "";
    });

    window.addEventListener("load", () => {
      placeAtStage("stage1");
      startReadyMusic();
    });
  </script>
</body>
</html>
